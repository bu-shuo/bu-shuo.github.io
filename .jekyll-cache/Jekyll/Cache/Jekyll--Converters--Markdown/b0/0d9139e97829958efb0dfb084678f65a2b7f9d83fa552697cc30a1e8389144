I"! <p><br /></p>

<h1 id="0x00-介绍">0x00 介绍</h1>
<hr />

<p>恶意软件的开发与检测技术是在不断地博弈中发展，随着反病毒软件（AV）由静态和启发式分析到对恶意行为检测算法的发展，需要更多创新的绕过技术。目前在恶意软件开发者和红队中流行的一种绕过技术就是无文件攻击（LotL）技术。LotL 技术指的是使用系统上已存在的或易于安装的二进制文件来进行后渗透攻击。从红队到有组织的犯罪团体使用的安全工具中，经常有利用 LotL 技术，如下图列出了一些 APT 组织使用到的 LotL 技术。</p>

<p><img src="https://bu-shuo.github.io/image/2021-07-25-01.jpg" alt="APT 组织使用 LotL 技术情况" /></p>

<p>尽管在信息安全领域，无文件攻击（LotL）是一个相对知名的术语，但很难找到一个精确的定义，很多关于 LotL 技术的文档都是以博客形式出现的，并没有 LotL 技术在恶意软件样本中使用程度的系统研究。所以本文以 Windows 操作系统为研究重点，首先会定义什么是 LotL 二进制文件，以及恶意软件如何利用其进行恶意操作，并针对以下的研究问题展开实验与评估：</p>

<ol>
  <li>LotL 技术可以有效绕过商业杀毒软件（AV）的检测嘛？</li>
  <li>在恶意软件中使用 LotL 二进制文件有多普遍？
    <ul>
      <li>恶意软件使用 LotL 技术的目的是什么？</li>
      <li>哪些恶意软件家族和类型使用 LotL 二进制文件最多，它们的用法有何不同?</li>
    </ul>
  </li>
  <li>在使用 LotL 二进制文件方面，合法的二进制文件和恶意二进制文件的行为有哪些相同和不同？这将对启发式杀毒引擎的检测能力有什么影响？</li>
</ol>

<h1 id="0x01-贡献">0x01 贡献</h1>
<hr />

<ol>
  <li>通过使用 LotL 技术部署恶意负载来测试一组杀毒引擎并评估 LotL 技术的绕过能力，实验表明对 LotL 技术的检测是当前杀毒软件行业面临的一大挑战。</li>
  <li>通过在几个商业恶意软件数据集进行评估，确定了 LotL 技术的流行程度和不同恶意软件家族和类型之间的差异，同时还评估了由于对 LotL 技术的误报对行业产生的影响。</li>
  <li>通过评估一个 APT 恶意软件数据集确定了哪些 APT 组织使用 LotL 技术最多。</li>
</ol>

<h1 id="0x02-背景">0x02 背景</h1>
<hr />

<h3 id="1-lotl-二进制文件">1. LotL 二进制文件</h3>
<p>由于安全社区对于无文件攻击二进制文件（Living-Off-the-Land binary，LOLbin）这个术语没有达成共识，所以文章首先定义 LotL binary 为任何被确认合法使用的二进制文件，它在攻击期间被利用来直接执行恶意操作或者间接地协助一系列最终会造成恶意后果的行动。这些合法的二进制文件主要分为以下三类：
	- 在 Windows 系统上默认安装的二进制文件
	- 被微软认证签名过的大多数二进制文件
	- 使用外部签名的二进制文件</p>
<h3 id="2-研究范围">2. 研究范围</h3>
<p>本文主要关注 Windows 恶意软件的各种目的，通常包括按照入侵杀伤链攻击或绕过杀软检测。另外 Process Hollowing &amp; Injection 不在本文讨论的范围，因为按照本文对 LotL 技术的定义，它们不属于 LotL。</p>
<h3 id="3-相关工作">3. 相关工作</h3>
<p>目前的学术文献中，LotL 恶意软件及其别名很少被提及，这主要局限于介绍性分析或被描述为一种新的恶意软件变体。Li 等人对恶意 Powershell 脚本进行了分析，其中有一个小节专门介绍了 LotL 攻击。Wang 等人最近发表的一篇关于数据来源分析的论文将 living-off-land 识别为一种新兴的绕过检测的恶意软件。Pendergrass 等人认为 LotL 是一种经常不被检测到的恶意软件子类型。<br />
Cohen 将 LotL 描述为最近在威胁行动中精英们使用的战术，并且成为了一种趋势。Hassan 等人的研究表明，APT 恶意软件使用 LotL 攻击策略来进行持续活动。<br />
在检测和防御 LotL 攻击方面，Ugarte 等人通过识别可疑行为的模式对 Powershell.exe 调用的恶意脚本进行检测。Rubin 等人将机器学习应用于 Powershell 恶意脚本的检测。Curtsinger 等人提出了针对恶意 Javascript 的检测机制。</p>

<h1 id="0x03-杀毒软件-vs-lotl-技术">0x03 杀毒软件 V.S. LotL 技术</h1>
<hr />

<p>作者首先选择了 10 个具有代表性的终端杀毒（AV）软件，并利用 LotL 技术执行反向 shell 来模拟发起攻击。这里需要再次强调作者的目的不是为了测试任何特定的 AV 产品检测能力，而是确定不同的 AV 产品之间是否存在普遍的检测差距。<br />
作者在联网的 Windows10 虚拟机上进行实验，使本地 AV 产品保持更新并连接到云服务。通过不同的 LotL 二进制文件运行一个拥有远控能力的反向 shell 来进行实验，结果是 60 种情况下只有 4 种被检测到。作者也积极联系了这些 AV 厂商进行反馈，并在 90 天后重新使用 60 个完全相同的有效载荷，结果只有25个能被检测到（如下图）。</p>

<p><img src="https://bu-shuo.github.io/image/2021-07-25-02.jpg" alt="AV 检测结果对比" /></p>

<p>作者在修改有效载荷和参数不变的情况下，又进行了一次实验，结果在之前被检测到的 25 种情况下又有 19 个可以成功建立反向 shell 。这表明 LotL 技术对于 AV 产品仍是一个重大的挑战，安全公司很难在没有误报的情况下部署有效的检测策略。</p>

<h1 id="0x04-lotl-技术的流行程度">0x04 LotL 技术的流行程度</h1>
<hr />

<h3 id="1-数据集">1. 数据集</h3>
<p>作者从 VirusTotal 获取行为报告中获取哈希值，并通过 VirusShare、VX-Unground、MalShare 等网站收集样本。为了平衡恶意软件家族与变体，作者使用了 AVClass 项目中的预处理代码，使标签规范化，再使用基于最小哈希的算法来评测 AV 标签的相似性。同时作者从各威胁情报公司或网上收集 APT 报告，并且在 VT 部署了三个 Yara 规则用于实时搜集 VT 上额外的数据集。最终一共收集到 31,805,549 个样本和 16,048,202 个行为报告。</p>

<h3 id="2-lotl-技术的识别">2. LotL 技术的识别</h3>
<p>过使用模式匹配来识别来处理所有收集到的行为报告，从而识别恶意软件执行过程中对 LotL 二进制文件的调用。为此作者分析了包括 Shell 命令以及样本的执行过程，在执行过程中识别两种二进制程序： 默认的系统二进制程序 和 已签名的二进制程序。再通过模式匹配细化，迭代地验证每个结果集，识别错误分类并将结果从数据库中剔除，最终保留包含 LotL 技术的样本。</p>

<h3 id="3-通过参数分析确定执行目的">3. 通过参数分析确定执行目的</h3>
<p>作者通过恶意软件样本提供的参数来确定 LotL 技术执行的目的，下图说明了从命令行到之形目的映射：</p>

<p><img src="https://bu-shuo.github.io/image/2021-07-25-03.jpg" alt="命令行到目的的映射" /></p>

<p>在将单个命令映射到执行目的后，作者对所有的二进制文件匹配了特定的执行目的，最终将执行目的分为九个类别：</p>

<ol>
  <li>关于执行的类别
    <ul>
      <li>代理执行（Proxied Execution）</li>
      <li>持久化（Persistence）</li>
      <li>延迟执行（Delayed Execution）</li>
    </ul>
  </li>
  <li>关于修改底层系统组件的类别
    <ul>
      <li>防火墙的修改（Firewall Modification）</li>
      <li>注册表的修改（Registry Modification）</li>
      <li>权限修改（Permission Modification）</li>
    </ul>
  </li>
  <li>无关执行与系统修改的
    <ul>
      <li>打开文件（File Open）</li>
      <li>侦察（Reconnaissance）</li>
      <li>终止任务（Task Stopping）</li>
    </ul>
  </li>
</ol>

<h1 id="0x05-评估结果">0x05 评估结果</h1>
<ol>
  <li>LotL 技术在商业恶意软件中的流行程度</li>
</ol>
:ET